<!doctype html>
<html>
	<head>
		<title>learningthree.js boiler plate for three.js</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		
    <script src="vendor/Prototype.js"></script>
    <script src="vendor/jQuery.js"></script>
    <script src="vendor/cannon/Cannon.js"></script>
    <script src="vendor/three/Three.js"></script>
		<script src="vendor/three/Detector.js"></script>
		<!-- https://github.com/mrdoob/stats.js -->
		<script src="vendor/three/Stats.js"></script>
		<script src="vendor/threex/THREEx.WindowResize.js"></script>
    <script src="vendor/threex/THREEx.KeyboardState.js"></script>
    <script src="vendor/EventEmitter.js"></script>
    <script src="vendor/Underscore.js"></script>
    <script src="vendor/dat.gui.min.js"></script>
    <script src="js/physics.js"></script>
    <script src="js/input.js"></script>
    <script src="js/game.js"></script>
    <script src="js/component.js"></script>
    <script src="js/entity.js"></script>
    <script src="js/prefab.js"></script>
    <script src="js/components/controller.js"></script>
    <script src="js/components/rigidbody.js"></script>
    <script src="js/components/follow.js"></script>
    <script src="js/components/interface.js"></script>

		<link  href="css/main.css" rel="stylesheet"/>
	</head>
<body>
  <div id="amoeba"></div>
	<script type="text/javascript">
    var Amoeba = new Game({
      canvas: '#amoeba',
      width: window.innerWidth,
      height: window.innerHeight,
      debug: true,
    });

    Prefab.define("PlayerCamera", function() {
      var camera = new Entity.Camera(
        45, 
        window.innerWidth / window.innerHeight,
        0.1,
        10000
      ); 

      var follow = new Follow();
      follow.offset = new THREE.Vector3(0, 200, -1); //Fuck you, gimbal.

      var controls = new Controller({
        'forward': function() {
          var tar = this.getComponent("follow").target;
          tar.getComponent("rigidbody")._body.force.z = 200;
        },
        'left': function() {
          var tar = this.getComponent("follow").target;
          tar.getComponent("rigidbody")._body.force.x = 200;
        },
        'right': function() {
          var tar = this.getComponent("follow").target;
          tar.getComponent("rigidbody")._body.force.x = -200;
        },
        'back': function() {
          var tar = this.getComponent("follow").target;
          tar.getComponent("rigidbody")._body.force.z = -200;
        },
        'query': function() {
          this.getComponent("follow").offset.add(new THREE.Vector3(0, 50, 0));
        },
        'use': function() {
          this.getComponent("follow").offset.add(new THREE.Vector3(0, -50, 0));
        }
      });
      camera.addComponent(follow);
      camera.addComponent(controls);
      return camera;
    });
    var camera = Amoeba.addEntity("PlayerCamera");

    Prefab.define("Player", function() {
      var master = new Entity.Mesh(
        "Player",
        new THREE.SphereGeometry(),
        new THREE.MeshPhongMaterial()
      );
      var mbody = new Rigidbody(0.5, new CANNON.Sphere(50));
      mbody._body.position.set(0, 100, 0);

      var inter = new Interface({
        'position': {
          target: master,
          setup: function(el) {
            $(document.createElement('p'))
            .addClass('x')
            .css({
              color: '#ff0000'
            })
            .appendTo($(el));

            $(document.createElement('p'))
            .addClass('y')
            .css({
              color: '#00ff00'
            })
            .appendTo($(el));

            $(document.createElement('p'))
            .addClass('z')
            .css({
              color: '#0000ff'
            })
            .appendTo($(el));
          },
          update: function(el) {
            $(el).find('.x').text(this.position.x.toPrecision(5));
            $(el).find('.y').text(this.position.y.toPrecision(5));
            $(el).find('.z').text(this.position.z.toPrecision(5));
          }
        }
      });
      master.addComponent(inter);
      master.addComponent(mbody);
      return master;
    });
    var player = Amoeba.addEntity("Player");
    camera.getComponent("follow").target = player;

    // TEST SHIT
    Prefab.define("Circles", function() {
      var visited = [];
      var c = new THREE.CircleGeometry();
      var m = new THREE.Mesh(
        new THREE.CircleGeometry(),
        new THREE.MeshBasicMaterial()
      );
      m.position.set(-50, 0, 0);
      THREE.GeometryUtils.merge(c, m);

      var vlist = c.vertices.filter(function(el) {
        var eps = 0.0001;
        return (Math.abs(el.x) > eps) || 
          (Math.abs(el.y) > eps) || 
          (Math.abs(el.z) > eps);
      });
      var v = vlist[0];

      var itr = function(el) {
        return (el.x == v.x) && (el.y == v.y) && (el.z == v.z);
      };

      while(!_.find(visited, itr)) {
        visited.push(v);

        var vn = new THREE.Vector3().copy(v).normalize();
        var vt = Math.atan2(vn.x, vn.y);
        vt = (vt < 0) ? (2 * Math.PI) + vt : vt;

        vlist = _.sortBy(vlist, function(a) {
          var an = new THREE.Vector3().copy(a).normalize();
          var at = Math.atan2(an.x - vn.x, an.y - vn.y);
          at = at - vt;
          at = (at < 0) ? (2 * Math.PI) + at : at;

          return at;
        });
        v = vlist[1];
        console.log(v);
      }
      _.each(visited, function(el) { console.log(el) });

      var spline = new THREE.Spline(visited);
      var geometry = new THREE.Geometry();
      var pos, idx;
      var colors = [];
      var material = new THREE.LineBasicMaterial({ 
        color: 0xffffff,
        linewidth: 3
      });

      for(var i = 0; i < visited.length * 6; i++) {
        idx = i / (visited.length * 6);
        pos = spline.getPoint(idx);

        geometry.vertices[i] = new THREE.Vector3(pos.x, pos.y, pos.z);
        colors[i] = new THREE.Color(0xffffff);
        colors[i].setHSL(0.6, 1.0, Math.max(0, -pos.x / 200) + 0.5);
      }
      console.log(geometry.vertices);
      geometry.colors = colors;

      var line = new THREE.Line(geometry, material);
      line.position.set(0, 100, 0);
      line.rotation.x = Math.PI / 2;
      Amoeba._scene.add(line);
      
      var m = new Entity.Mesh(c, new THREE.MeshLambertMaterial());
      m.rotation.x = -Math.PI / 2;
      m.position.set(0, 50, 0);
      return m;
    });
    Amoeba.addEntity("Circles");

    Prefab.define("Ground", function() {
      var pln = new THREE.PlaneGeometry(1000, 1000, 20, 20)
        , gma = new THREE.MeshLambertMaterial()
        , gcd = new CANNON.Plane();

      var ground = new Entity.Mesh("Ground", pln, gma);
      var sbd = new Rigidbody(0, gcd);
      sbd._body.quaternion.setFromAxisAngle(
        new CANNON.Vec3(1, 0, 0), 
        -Math.PI / 2
      );

      ground.addComponent(sbd);
      return ground;
    });
    Amoeba.addEntity("Ground");

    var light = new Entity.PointLight("Light", 0xff0000, 1, 1000);
    light.position.set(0, 300, 0);
    Amoeba.addEntity(light);

    var helpZ = new THREE.ArrowHelper(
      new THREE.Vector3(0, 0, 1),
      new THREE.Vector3(0, 0, 0),
      50,
      0xFF0000
    );
    var helpX = new THREE.ArrowHelper(
      new THREE.Vector3(1, 0, 0),
      new THREE.Vector3(0, 0, 0),
      50,
      0x00FF00
    );
    Amoeba._scene.add(helpZ);
    Amoeba._scene.add(helpX);
    Amoeba.run();
    
	</script>
</body>
</html>
